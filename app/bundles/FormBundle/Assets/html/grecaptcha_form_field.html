<script type="text/javascript">
window.grecaptcha_config = window.grecaptcha_config || {};

window.getOnCaptchaCallback = window.getOnCaptchaCallback || function(formTag) {
    return function(token) {
        MauticSDK.validateForm(formTag.getAttribute("data-mautic-form"), true);
        formTag.submit();
        var captchaToReset = window.grecaptcha_config[formTag.id]["list"][formTag["grecaptcha_index"]];
        grecaptcha.reset(captchaToReset);
    }
}

window.getSubmitButtons = window.getSubmitButtons || function(node) {
    var q = [];
    q.push(node);
    out = []
    while(q.length > 0) {
        var e = q.shift();
        if (e.tagName === "BUTTON" && e.type === "submit") {
            out.push(e);
        }
        var children = e.childNodes;
        for(j = children.length-1; j >= 0 ; j--) {
            q.push(children[j]);
        }
    }
    return out;
};

getAllValidForms = function() {
    var forms = document.getElementsByTagName("form");
    var out = []

    for (var i = forms.length-1; i >= 0 ; i--) {
        var e = forms[i];
        if(e.hasAttribute("data-mautic-form")) {
            out.push(e);
        }
    }
    return out;
}

onloadCallback = window.onloadCallback || function() {
    window.onLoadCallCount = window.onLoadCallCount || 0;
    window.onLoadCallCount +=1;
    var forms = getAllValidForms();
    if(forms.length > window.onLoadCallCount) {
        return;
    }

    for(var i = 0; i < forms.length; i++) {
            var f = forms[i];
            var button = getSubmitButtons(f)[0];
            var captchaId = grecaptcha.render(
                button,
                {
                    "sitekey": "%s",
                    "theme":"light",
                    "type":"image",
                    "callback": window.getOnCaptchaCallback(f)
                });
            if (window.grecaptcha_config[f.id] === undefined) {
               window.grecaptcha_config[f.id] = { "list": [captchaId] , "last": 0};
            }else{
               window.grecaptcha_config[f.id]["list"].push(captchaId);
               window.grecaptcha_config[f.id]["last"] += 1;
            }
            f["grecaptcha_index"] = window.grecaptcha_config[f.id]["last"];
      }
}
</script>

<script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit" async defer> </script>
